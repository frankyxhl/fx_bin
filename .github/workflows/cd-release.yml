name: CD Release

on:
  push:
    branches: [main]

# Prevent concurrent releases
concurrency:
  group: release
  cancel-in-progress: false

jobs:
  release:
    # Prevent recursion - CRITICAL for avoiding infinite loops
    if: |
      github.actor != 'github-actions[bot]' &&
      !contains(github.event.head_commit.message, 'chore(release):')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write  # For trusted publishing

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.SEMANTIC_RELEASE_PAT }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Poetry
        run: pipx install poetry

      - name: Semantic Release (Version + Tag + Changelog + GitHub Release)
        id: semantic-release
        uses: python-semantic-release/python-semantic-release@v9
        with:
          github_token: ${{ secrets.SEMANTIC_RELEASE_PAT }}
          git_committer_name: "github-actions[bot]"
          git_committer_email: "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Get new version
        if: steps.semantic-release.outputs.version != ''
        id: version
        run: |
          VERSION=${{ steps.semantic-release.outputs.version }}
          echo "current_version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ New version: $VERSION"
          echo "## ðŸŽ‰ New Version Released" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY

      - name: Check if version exists on PyPI
        if: steps.semantic-release.outputs.version != ''
        id: pypi_check
        run: |
          VERSION="${{ steps.version.outputs.current_version }}"
          echo "Checking if version $VERSION exists on PyPI..."

          # Check PyPI API for existing version
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://pypi.org/pypi/fx-bin/$VERSION/json")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "version_exists=true" >> $GITHUB_OUTPUT
            echo "âŒ Version $VERSION already exists on PyPI - skipping deployment"
            echo "## â­ï¸ Deployment Skipped" >> $GITHUB_STEP_SUMMARY
            echo "Version **$VERSION** already exists on PyPI" >> $GITHUB_STEP_SUMMARY
          else
            echo "version_exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Version $VERSION does not exist on PyPI - OK to deploy"
            echo "**Status:** Ready to deploy ðŸš€" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Install dependencies and build
        if: steps.pypi_check.outputs.version_exists == 'false'
        run: |
          echo "ðŸ“¦ Building package version ${{ steps.version.outputs.current_version }}..."
          poetry install
          poetry build

      - name: Upload build artifacts to GitHub Release
        if: steps.pypi_check.outputs.version_exists == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.SEMANTIC_RELEASE_PAT }}
        run: |
          VERSION="${{ steps.version.outputs.current_version }}"
          echo "ðŸ“Ž Uploading build artifacts to GitHub Release v$VERSION..."

          # Wait for release to be available (with retry)
          echo "Waiting for release to be available..."
          for i in {1..10}; do
            if gh release view "v$VERSION" &>/dev/null; then
              echo "âœ… Release v$VERSION is available"
              break
            fi
            echo "â³ Waiting for release (attempt $i/10)..."
            sleep 3
            if [ $i -eq 10 ]; then
              echo "âŒ Release not found after 30 seconds"
              exit 1
            fi
          done

          # Upload all dist files with error handling
          UPLOAD_SUCCESS=true
          for file in dist/*; do
            if [ -f "$file" ]; then
              FILENAME=$(basename "$file")
              echo "ðŸ“¦ Uploading $FILENAME..."

              if gh release upload "v$VERSION" "$file" --clobber; then
                echo "  âœ… Successfully uploaded $FILENAME"
              else
                echo "  âŒ Failed to upload $FILENAME"
                UPLOAD_SUCCESS=false
              fi
            fi
          done

          if [ "$UPLOAD_SUCCESS" = false ]; then
            echo "âŒ Some artifacts failed to upload"
            exit 1
          fi

          echo "âœ… All build artifacts uploaded to https://github.com/frankyxhl/fx_bin/releases/tag/v$VERSION"

      - name: Deploy to PyPI
        if: steps.pypi_check.outputs.version_exists == 'false'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true

      - name: Deployment success
        if: steps.pypi_check.outputs.version_exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.current_version }}"
          echo "ðŸš€ Successfully deployed fx-bin version $VERSION!"
          echo ""
          echo "ðŸ“¦ PyPI: https://pypi.org/project/fx-bin/$VERSION/"
          echo "ðŸ“¦ GitHub Release: https://github.com/frankyxhl/fx_bin/releases/tag/v$VERSION"
          echo "ðŸ“¦ Installation: pip install fx-bin==$VERSION"

          # Add to job summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## âœ… Deployment Successful

          **Version:** $VERSION

          ### ðŸ“¦ Package Links
          - **PyPI:** https://pypi.org/project/fx-bin/$VERSION/
          - **GitHub Release:** https://github.com/frankyxhl/fx_bin/releases/tag/v$VERSION

          ### ðŸ“¥ Installation
          \`\`\`bash
          pip install fx-bin==$VERSION
          \`\`\`
          EOF

      - name: Deployment status summary
        if: always()
        run: |
          if [[ "${{ steps.semantic-release.outputs.version }}" == "" ]]; then
            echo "## â„¹ï¸ No Release" >> $GITHUB_STEP_SUMMARY
            echo "No new version to release (no conventional commits since last release)" >> $GITHUB_STEP_SUMMARY
          fi
